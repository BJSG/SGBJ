import React, { useState, useEffect } from 'react';
import { Calculator, TrendingUp, Package, Truck, Settings, PieChart, Info, AlertTriangle, ArrowRightLeft } from 'lucide-react';

const App = () => {
  // --- 状态管理 ---
  
  // 基础设置
  // 汇率：1 CNY = ? RUB (例如 11.36)
  const [exchangeRate, setExchangeRate] = useState(11.36); 
  const [platform, setPlatform] = useState('wildberries');

  // 产品成本 (CNY)
  const [sourcingCostCNY, setSourcingCostCNY] = useState(50); // 采购价
  const [domesticShippingCNY, setDomesticShippingCNY] = useState(6); // 国内运费

  // 物流成本 (CNY)
  const [weight, setWeight] = useState(1); // 重量 kg
  const [shippingRate, setShippingRate] = useState(55); // 头程运费单价 CNY/kg
  const [extraLogisticsCostCNY, setExtraLogisticsCostCNY] = useState(0); // 尾程/操作费 (CNY)

  // 平台与运营费率 (%) - 均基于售价 (RUB) 计算
  const [platformFeePercent, setPlatformFeePercent] = useState(12); // WB佣金
  const [paymentFeePercent, setPaymentFeePercent] = useState(2); // 收款/提现手续费
  const [exchangeLossPercent, setExchangeLossPercent] = useState(2); // 汇损率
  const [returnRatePercent, setReturnRatePercent] = useState(20); // 退货率 (现在基于售价计算)
  const [adCosPercent, setAdCosPercent] = useState(0); // 广告占比
  const [fixedFeeRUB, setFixedFeeRUB] = useState(0); // 单笔固定费 (卢布)

  // 目标与定价
  const [targetMarginPercent, setTargetMarginPercent] = useState(30); // 目标利润率 %
  const [sellingPriceRUB, setSellingPriceRUB] = useState(2500); // 最终售价 RUB
  
  const [mode, setMode] = useState('byPrice'); // 'byPrice' | 'byMargin'

  // 结果状态 (全部折算为 CNY 展示)
  const [results, setResults] = useState({
    totalProductCostCNY: 0,
    logisticsCNY: 0,
    returnLossCNY: 0,
    platformFeeCNY: 0,
    paymentFeeCNY: 0,
    exchangeLossCNY: 0,
    marketingCNY: 0,
    fixedFeeCNY: 0,
    
    totalCostCNY: 0,
    netProfitCNY: 0,
    
    margin: 0,
    roi: 0,
    breakEvenPriceRUB: 0,
    suggestedPriceRUB: 0
  });

  // --- 预设配置 ---
  const presets = {
    wildberries: {
      name: 'Wildberries (WB)',
      platformFee: 15,
      paymentFee: 1.0,
      exchangeLoss: 3.0,
      returnRate: 20,
      adCos: 10
    },
    ozon: {
      name: 'Ozon',
      platformFee: 10,
      paymentFee: 1.0,
      exchangeLoss: 2.0,
      returnRate: 5,
      adCos: 10
    }
  };

  const applyPreset = (key) => {
    setPlatform(key);
    const p = presets[key];
    setPlatformFeePercent(p.platformFee);
    setPaymentFeePercent(p.paymentFee);
    setExchangeLossPercent(p.exchangeLoss);
    setReturnRatePercent(p.returnRate);
    setAdCosPercent(p.adCos);
  };

  // --- 核心计算逻辑 ---
  useEffect(() => {
    const calculate = () => {
      // 1. 基础固定支出 (CNY)
      const productCost = (parseFloat(sourcingCostCNY) || 0) + (parseFloat(domesticShippingCNY) || 0);
      const logisticsCost = ((parseFloat(weight) || 0) * (parseFloat(shippingRate) || 0)) + (parseFloat(extraLogisticsCostCNY) || 0);
      
      // 2. 变动费率合计 (全部基于售价)
      const totalVariableRate = (
        (parseFloat(platformFeePercent) || 0) + 
        (parseFloat(paymentFeePercent) || 0) + 
        (parseFloat(exchangeLossPercent) || 0) + 
        (parseFloat(adCosPercent) || 0) +
        (parseFloat(returnRatePercent) || 0) 
      ) / 100;

      let activePriceRUB = parseFloat(sellingPriceRUB) || 0;
      
      // 模式 A: 通过目标利润率反推售价
      if (mode === 'byMargin') {
        const fixedCostsRUB = (productCost + logisticsCost) * (parseFloat(exchangeRate) || 1) + (parseFloat(fixedFeeRUB) || 0);
        const denominator = 1 - totalVariableRate - ((parseFloat(targetMarginPercent) || 0) / 100);
        
        if (denominator > 0) {
          activePriceRUB = fixedCostsRUB / denominator;
        } else {
          activePriceRUB = 0;
        }
      }

      // --- 基于当前售价 (activePriceRUB) 计算结果详情 ---
      const currentExchangeRate = parseFloat(exchangeRate) || 1;
      const revenueCNY = activePriceRUB / currentExchangeRate;

      // 各项变动成本 (CNY)
      const pFeeCNY = (activePriceRUB * ((parseFloat(platformFeePercent) || 0) / 100)) / currentExchangeRate;
      const payFeeCNY = (activePriceRUB * ((parseFloat(paymentFeePercent) || 0) / 100)) / currentExchangeRate;
      const exLossCNY = (activePriceRUB * ((parseFloat(exchangeLossPercent) || 0) / 100)) / currentExchangeRate;
      const adFeeCNY = (activePriceRUB * ((parseFloat(adCosPercent) || 0) / 100)) / currentExchangeRate;
      const returnLossCNY = (activePriceRUB * ((parseFloat(returnRatePercent) || 0) / 100)) / currentExchangeRate; 
      const fFeeCNY = (parseFloat(fixedFeeRUB) || 0) / currentExchangeRate;

      // 总支出 (CNY)
      const totalDeductionsCNY = productCost + logisticsCost + pFeeCNY + payFeeCNY + exLossCNY + adFeeCNY + returnLossCNY + fFeeCNY;
      
      // 净利润 (CNY)
      const netProfit = revenueCNY - totalDeductionsCNY;

      // 利润率 & ROI
      const margin = revenueCNY > 0 ? (netProfit / revenueCNY) * 100 : 0;
      const totalInvested = productCost + logisticsCost + adFeeCNY; 
      const roi = totalInvested > 0 ? (netProfit / totalInvested) * 100 : 0;

      // 保本价 (RUB)
      let breakEvenRUB = 0;
      if (totalVariableRate < 1) {
        breakEvenRUB = ((productCost + logisticsCost) * currentExchangeRate + (parseFloat(fixedFeeRUB) || 0)) / (1 - totalVariableRate);
      }

      setResults({
        totalProductCostCNY: productCost,
        logisticsCNY: logisticsCost,
        returnLossCNY: returnLossCNY,
        platformFeeCNY: pFeeCNY,
        paymentFeeCNY: payFeeCNY,
        exchangeLossCNY: exLossCNY,
        marketingCNY: adFeeCNY,
        fixedFeeCNY: fFeeCNY,
        
        totalCostCNY: totalDeductionsCNY,
        netProfitCNY: netProfit,
        
        margin: margin,
        roi: roi,
        breakEvenPriceRUB: breakEvenRUB,
        suggestedPriceRUB: activePriceRUB
      });
    };

    calculate();
  }, [
    exchangeRate, sourcingCostCNY, domesticShippingCNY, 
    weight, shippingRate, extraLogisticsCostCNY,
    platformFeePercent, paymentFeePercent, exchangeLossPercent, returnRatePercent, adCosPercent, fixedFeeRUB,
    targetMarginPercent, sellingPriceRUB, mode
  ]);

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
      {/* 头部 */}
      <div className="bg-fuchsia-800 text-white p-6 shadow-lg">
        <div className="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-3">
            <Calculator className="w-8 h-8" />
            <div>
              <h1 className="text-2xl font-bold tracking-tight">WB 跨境定价计算器</h1>
              <div className="text-fuchsia-200 text-xs">Wildberries 俄罗斯专供版</div>
            </div>
          </div>
          
          <div className="flex items-center gap-4 bg-fuchsia-900/40 px-5 py-3 rounded-lg backdrop-blur-sm border border-fuchsia-600/30">
            <div className="flex flex-col items-end">
              <span className="text-xs text-fuchsia-200 font-medium mb-1">汇率设置 (1 CNY = ? RUB)</span>
              <div className="flex items-center gap-2">
                <span className="text-sm font-bold">¥ 1 = </span>
                <input 
                  type="number" 
                  value={exchangeRate}
                  onChange={(e) => setExchangeRate(e.target.value)}
                  className="w-20 bg-white text-fuchsia-900 px-2 py-1 rounded font-bold text-center outline-none border-2 border-transparent focus:border-fuchsia-400"
                />
                <span className="text-sm font-bold">₽</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-5xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-4">
        
        {/* 左侧：输入区域 */}
        <div className="lg:col-span-7 space-y-5">
          
          {/* 1. 快速预设 */}
          <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <h3 className="flex items-center gap-2 font-semibold text-slate-700 mb-3 text-sm uppercase tracking-wide">
              <Settings className="w-4 h-4 text-fuchsia-600" />
              快速配置
            </h3>
            <div className="flex gap-3">
              <button
                onClick={() => applyPreset('wildberries')}
                className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold transition-all ${
                  platform === 'wildberries' 
                    ? 'bg-fuchsia-600 text-white shadow-md ring-2 ring-fuchsia-200' 
                    : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                }`}
              >
                Wildberries
              </button>
              <button
                onClick={() => applyPreset('ozon')}
                className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold transition-all ${
                  platform === 'ozon' 
                    ? 'bg-blue-600 text-white shadow-md' 
                    : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                }`}
              >
                Ozon
              </button>
            </div>
          </div>

          {/* 2. 采购与物流 (CNY) */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <h3 className="flex items-center gap-2 font-semibold text-slate-700 mb-4 text-sm uppercase">
                <Package className="w-5 h-5 text-orange-500" />
                产品成本 (¥)
              </h3>
              <div className="space-y-4">
                <InputGroup label="采购单价 (CNY)" value={sourcingCostCNY} onChange={setSourcingCostCNY} symbol="¥" />
                <InputGroup label="国内运费 (CNY)" value={domesticShippingCNY} onChange={setDomesticShippingCNY} symbol="¥" />
              </div>
            </div>

            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <h3 className="flex items-center gap-2 font-semibold text-slate-700 mb-4 text-sm uppercase">
                <Truck className="w-5 h-5 text-teal-500" />
                跨境物流 (¥)
              </h3>
              <div className="space-y-4">
                <div className="flex gap-4">
                  <InputGroup label="包裹重量 (kg)" value={weight} onChange={setWeight} />
                  <InputGroup label="运费单价 (¥/kg)" value={shippingRate} onChange={setShippingRate} symbol="¥" />
                </div>
                <InputGroup label="其他操作费 (¥)" value={extraLogisticsCostCNY} onChange={setExtraLogisticsCostCNY} symbol="¥" />
              </div>
            </div>
          </div>

          {/* 3. 费率配置 */}
          <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 ring-1 ring-fuchsia-100">
            <h3 className="flex items-center gap-2 font-semibold text-slate-700 mb-4 text-sm uppercase">
              <PieChart className="w-5 h-5 text-fuchsia-600" />
              变动费率与风险配置 (基于售价)
            </h3>
            
            <div className="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-6">
              <InputGroup label="平台佣金 (%)" value={platformFeePercent} onChange={setPlatformFeePercent} symbol="%" pos="right" />
              <InputGroup label="广告占比 (%)" value={adCosPercent} onChange={setAdCosPercent} symbol="%" pos="right" />
              <InputGroup label="单笔固定费 (₽)" value={fixedFeeRUB} onChange={setFixedFeeRUB} symbol="₽" />

              <div className="md:col-span-3 border-t border-slate-100 my-1 pt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                <InputGroup 
                  label="提现手续费 (%)" 
                  value={paymentFeePercent} 
                  onChange={setPaymentFeePercent} 
                  symbol="%" pos="right"
                />
                <InputGroup 
                  label="汇损率 (%)" 
                  value={exchangeLossPercent} 
                  onChange={setExchangeLossPercent} 
                  symbol="%" pos="right"
                />
                <InputGroup 
                  label="退货率 (%)" 
                  value={returnRatePercent} 
                  onChange={setReturnRatePercent} 
                  symbol="%" pos="right"
                  subtext="按售价比例计入损耗"
                />
              </div>
            </div>
            <div className="mt-4 p-3 bg-amber-50 rounded-lg flex gap-2">
              <Info className="w-4 h-4 text-amber-600 shrink-0" />
              <span className="text-[11px] text-amber-700">
                当前逻辑：退货损耗 = 销售额 × 退货率。这意味着你将退货率视为销售收入的直接抵减。
              </span>
            </div>
          </div>
        </div>

        {/* 右侧：计算结果 */}
        <div className="lg:col-span-5 space-y-6">
          
          {/* 定价控制台 */}
          <div className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-fuchsia-700">
            <div className="flex bg-slate-100 p-1 rounded-lg mb-6">
              <button 
                onClick={() => setMode('byPrice')}
                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'byPrice' ? 'bg-white text-fuchsia-700 shadow-sm' : 'text-slate-500'}`}
              >
                按定价算利润
              </button>
              <button 
                onClick={() => setMode('byMargin')}
                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'byMargin' ? 'bg-white text-fuchsia-700 shadow-sm' : 'text-slate-500'}`}
              >
                按利润推定价
              </button>
            </div>

            <div className="mb-6">
              {mode === 'byPrice' ? (
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1 font-bold">输入建议零售价 (RUB)</label>
                  <div className="relative">
                    <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-lg">₽</span>
                    <input 
                      type="number" 
                      value={sellingPriceRUB}
                      onChange={(e) => setSellingPriceRUB(e.target.value)}
                      className="w-full pl-10 pr-4 py-4 text-3xl font-bold text-slate-800 bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-fuchsia-500 outline-none"
                    />
                  </div>
                </div>
              ) : (
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1 font-bold">设定目标利润率 (%)</label>
                  <div className="relative">
                    <input 
                      type="number" 
                      value={targetMarginPercent}
                      onChange={(e) => setTargetMarginPercent(e.target.value)}
                      className="w-full px-4 py-4 text-3xl font-bold text-fuchsia-600 bg-fuchsia-50 border border-fuchsia-200 rounded-xl focus:ring-2 focus:ring-fuchsia-500 outline-none"
                    />
                    <span className="absolute right-6 top-1/2 -translate-y-1/2 text-fuchsia-400 font-bold text-xl">%</span>
                  </div>
                </div>
              )}
            </div>

            {/* 利润卡片 */}
            <div className="bg-slate-50 rounded-xl p-5 border border-slate-200">
              <div className="flex justify-between items-end mb-4">
                <div>
                  <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">单单净利润</div>
                  <div className={`text-3xl font-extrabold mt-1 ${results.netProfitCNY >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                    ¥ {results.netProfitCNY.toFixed(2)}
                  </div>
                </div>
                <div className="text-right">
                   <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">实际利润率</div>
                  <div className={`text-xl font-bold ${results.margin >= 15 ? 'text-fuchsia-600' : 'text-orange-500'}`}>
                     {results.margin.toFixed(1)}%
                   </div>
                </div>
              </div>

              <div className="grid grid-cols-1 gap-3 pt-4 border-t border-slate-200">
                {mode === 'byMargin' && (
                  <div className="bg-amber-100 p-4 rounded-lg border border-amber-200">
                    <div className="text-xs font-bold text-amber-700 mb-1 uppercase">建议卢布售价 (₽)</div>
                    <div className="flex justify-between items-end">
                      <span className="text-3xl font-black text-amber-900">₽ {(results.suggestedPriceRUB || 0).toFixed(0)}</span>
                      <span className="text-sm font-bold text-amber-700/80 mb-1">≈ ¥ {((results.suggestedPriceRUB || 0) / (parseFloat(exchangeRate) || 1)).toFixed(1)}</span>
                    </div>
                  </div>
                )}
                
                <div className="flex justify-between items-center px-2">
                  <span className="text-xs text-slate-500 flex items-center gap-1">
                    <TrendingUp className="w-3 h-3" /> 保本价 (零利润)
                  </span>
                  <div className="text-right font-bold text-slate-700">
                    ₽ {(results.breakEvenPriceRUB || 0).toFixed(0)} <span className="text-xs font-normal text-slate-400 ml-1">(¥ {((results.breakEvenPriceRUB || 0) / (parseFloat(exchangeRate) || 1)).toFixed(1)})</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* 成本拆解 */}
          <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <h3 className="font-semibold text-slate-700 mb-4 text-xs uppercase tracking-widest flex justify-between items-center">
              <span>每单资金流向 (CNY折算)</span>
              <span className="font-normal text-slate-400">1 ¥ = {exchangeRate} ₽</span>
            </h3>
            
            <div className="h-3 w-full flex rounded-full overflow-hidden mb-5 bg-slate-100">
              <div style={{ width: `${(results.totalProductCostCNY / (results.totalCostCNY + results.netProfitCNY || 1)) * 100}%` }} className="bg-blue-600" />
              <div style={{ width: `${(results.logisticsCNY / (results.totalCostCNY + results.netProfitCNY || 1)) * 100}%` }} className="bg-teal-500" />
              <div style={{ width: `${(results.returnLossCNY / (results.totalCostCNY + results.netProfitCNY || 1)) * 100}%` }} className="bg-red-400" />
              <div style={{ width: `${((results.platformFeeCNY + results.marketingCNY) / (results.totalCostCNY + results.netProfitCNY || 1)) * 100}%` }} className="bg-fuchsia-400" />
            </div>

            <div className="space-y-3 text-sm">
              <CostRow label="采购与国内运费" value={results.totalProductCostCNY} color="bg-blue-600" />
              <CostRow label="头程物流运费" value={results.logisticsCNY} color="bg-teal-500" />
              <CostRow label="退货风险损耗" value={results.returnLossCNY} color="bg-red-400" isAlert />
              
              <div className="border-t border-slate-100 my-2"></div>
              
              <div className="grid grid-cols-2 gap-x-6 gap-y-3">
                <CostRow label="平台佣金" value={results.platformFeeCNY} color="bg-fuchsia-400" small />
                <CostRow label="广告投入" value={results.marketingCNY} color="bg-fuchsia-300" small />
                <CostRow label="提现手续费" value={results.paymentFeeCNY} color="bg-orange-300" small />
                <CostRow label="预留汇损" value={results.exchangeLossCNY} color="bg-orange-200" small />
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
};

// --- 子组件 ---

const InputGroup = ({ label, value, onChange, step = "0.01", subtext, highlight, symbol, pos = "left" }) => (
  <div className="flex flex-col">
    <label className={`text-[11px] font-bold mb-1.5 uppercase ${highlight ? 'text-fuchsia-700' : 'text-slate-500'}`}>{label}</label>
    <div className="relative">
      {pos === 'left' && symbol && (
        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">{symbol}</span>
      )}
      <input 
        type="number" 
        step={step}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        className={`w-full py-2 border rounded-lg font-bold outline-none transition-colors text-sm
          ${pos === 'left' && symbol ? 'pl-7 pr-3' : ''}
          ${pos === 'right' && symbol ? 'pl-3 pr-8' : 'px-3'}
          ${highlight 
          ? 'bg-fuchsia-50 border-fuchsia-200 text-fuchsia-900 focus:ring-1 focus:ring-fuchsia-500' 
          : 'bg-slate-50 border-slate-200 text-slate-700 focus:ring-1 focus:ring-blue-500'
        }`}
      />
      {pos === 'right' && symbol && (
        <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">{symbol}</span>
      )}
    </div>
    {subtext && <span className="text-[10px] text-slate-400 mt-1 leading-tight">{subtext}</span>}
  </div>
);

const CostRow = ({ label, value, color, isAlert, small }) => (
  <div className={`flex items-center justify-between ${small ? 'text-[11px]' : ''}`}>
    <div className="flex items-center gap-2 overflow-hidden">
      <div className={`w-2 h-2 rounded-full shrink-0 ${color}`}></div>
      <span className={`text-slate-600 truncate ${isAlert ? 'text-red-500 font-bold' : ''}`}>{label}</span>
    </div>
    <div className="font-mono font-bold text-slate-700 shrink-0 ml-2">
      ¥ {(value || 0).toFixed(2)}
    </div>
  </div>
);

export default App;
